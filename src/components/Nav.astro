---
const { t, site, lang } = Astro.props as {
  t: any;
  site: any;
  lang: "en" | "es";
};

const phoneTel = (site?.phoneTel || "").toString().trim();
const phoneDisplay = (site?.phoneDisplay || phoneTel).toString().trim();

// ✅ Secondary phone (supports both "phoneTel2" and your current typo "photoTel2")
const phoneTel2 = (site?.phoneTel2 || site?.photoTel2 || "").toString().trim();
const phoneDisplay2 = (site?.phoneDisplay2 || phoneTel2).toString().trim();

const langHref = lang === "en" ? "/es/" : "/";
const homeHref = lang === "en" ? "/" : "/es/";

// i18n-safe labels
const menuLabel = t?.nav?.menu ?? (lang === "es" ? "Abrir menú" : "Open menu");

// ✅ Owner Portal (password-based, remembers for 7 days)
const ownerHref = lang === "en" ? "/owner-upload" : "/es/owner-upload";

// Reuse your existing env key so you don't have to change Vercel env names
const ownerPassword = import.meta.env.PUBLIC_OWNER_KEY || "";

// Optional contact fallback (auto-derives from site if present)
const siteEmail = (site?.email || site?.contactEmail || site?.ownerEmail || "").toString().trim();
const supportHref = siteEmail ? `mailto:${siteEmail}` : `tel:${phoneTel}`;

const ownerPortalLabel =
  t?.nav?.ownerPortal ?? (lang === "es" ? "Portal del Dueño" : "Owner Portal");

const ownerLogoutLabel =
  t?.nav?.ownerLogout ?? (lang === "es" ? "Cerrar sesión" : "Log out");

const ownerUnlockTitle =
  t?.nav?.ownerUnlockTitle ?? (lang === "es" ? "Acceso del Dueño" : "Owner Access");

const ownerUnlockHint =
  t?.nav?.ownerUnlockHint ??
  (lang === "es"
    ? "Ingrese su contraseña para abrir el formulario de subida."
    : "Enter your password to open the upload form.");

const ownerPasswordLabel =
  t?.nav?.ownerPasswordLabel ?? (lang === "es" ? "Contraseña" : "Password");

const ownerUnlockBtn =
  t?.nav?.ownerUnlockBtn ?? (lang === "es" ? "Entrar" : "Continue");

const ownerForgotLabel =
  t?.nav?.ownerForgot ?? (lang === "es" ? "¿Olvidó la contraseña?" : "Forgot password?");

const ownerContactLabel =
  t?.nav?.ownerContact ?? (lang === "es" ? "Contactar" : "Contact");

const ownerErrorLabel =
  t?.nav?.ownerError ?? (lang === "es" ? "Contraseña incorrecta." : "Incorrect password.");

const ownerCloseLabel =
  t?.nav?.close ?? (lang === "es" ? "Cerrar" : "Close");

// ✅ Secondary call label (no new i18n required)
const callAltLabel = t?.nav?.callAlt ?? (lang === "es" ? "Llamar 2" : "Call 2");

// Storage keys
const OWNER_UNLOCK_UNTIL_KEY = "rlc_owner_unlocked_until";
const OWNER_UNLOCK_DAYS = 7; // remember for 7 days
---

<header
  id="siteHeader"
  class="sticky top-0 z-50 isolate border-b border-slate-200/60 bg-white/85 backdrop-blur supports-backdrop-filter:bg-white/70 pointer-events-auto transition"
>
  <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 pointer-events-auto">
    <a href={homeHref} class="flex items-center gap-3 min-w-0 pointer-events-auto">
      <img
        src={site.assets.logo}
        alt={site.brandName}
        class="h-10 w-auto shrink-0"
        loading="eager"
        decoding="async"
      />

      <div class="min-w-0">
        <p class="brand-clamp text-[13px] font-semibold leading-tight text-brand-900 sm:text-sm sm:leading-normal">
          {site.brandName}
        </p>
        <p class="hidden sm:block text-xs text-slate-600">Haines City • Kissimmee • Davenport</p>
      </div>
    </a>

    <!-- Desktop nav -->
    <nav class="hidden items-center gap-6 md:flex pointer-events-auto" aria-label="Primary">
      <a class="navlink" data-navlink href="#services">{t.nav.services}</a>
      <a class="navlink" data-navlink href="#quote">{t.nav.quote}</a>
      <a class="navlink" data-navlink href="#contact">{t.nav.contact}</a>

      <button
        type="button"
        class="navlink"
        id="ownerPortalBtnDesktop"
        aria-haspopup="dialog"
        aria-controls="ownerGate"
      >
        {ownerPortalLabel}
      </button>

      <a class="btn btn-outline px-4" href={langHref} aria-label="Toggle language" title={t.nav.toggle}>
        {t.nav.toggle}
      </a>

      <!-- ✅ Primary call -->
      <a class="btn btn-primary" href={`tel:${phoneTel}`} aria-label={t.nav.callNow}>
        {t.nav.callNow}: {phoneDisplay}
      </a>

      <!-- ✅ Secondary call (renders if phoneTel2 exists; display falls back safely) -->
      {phoneTel2 ? (
        <a class="btn btn-outline px-4" href={`tel:${phoneTel2}`} aria-label={callAltLabel}>
          {callAltLabel}: {phoneDisplay2}
        </a>
      ) : null}
    </nav>

    <!-- Mobile -->
    <div class="flex items-center gap-2 md:hidden shrink-0 pointer-events-auto">
      <a class="btn btn-outline px-3" href={langHref} aria-label="Toggle language" title={t.nav.toggle}>
        {t.nav.toggle}
      </a>

      <a class="btn btn-primary" href={`tel:${phoneTel}`} aria-label={t.nav.callNow}>
        {t.nav.callNow}
      </a>

      <button
        id="menuBtn"
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200/70 bg-white/90 text-brand-900 shadow-soft ring-1 ring-black/5 transition hover:bg-white focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 focus-visible:ring-offset-2 pointer-events-auto"
        aria-label={menuLabel}
        aria-expanded="false"
        aria-controls="mobileMenu"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5" aria-hidden="true">
          <path fill-rule="evenodd" d="M3.75 6.75A.75.75 0 0 1 4.5 6h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75ZM3.75 12a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15A.75.75 0 0 1 3.75 12Zm.75 5.25a.75.75 0 0 0 0 1.5h15a.75.75 0 0 0 0-1.5h-15Z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile dropdown menu -->
  <div id="mobileMenu" class="hidden border-t border-slate-200/60 bg-white/95 backdrop-blur pointer-events-auto">
    <div class="mx-auto max-w-6xl px-4 py-4">
      <div class="grid gap-2">
        <a class="navlink block rounded-xl px-3 py-2 hover:bg-brand-50" data-navlink href="#services">{t.nav.services}</a>
        <a class="navlink block rounded-xl px-3 py-2 hover:bg-brand-50" data-navlink href="#quote">{t.nav.quote}</a>
        <a class="navlink block rounded-xl px-3 py-2 hover:bg-brand-50" data-navlink href="#contact">{t.nav.contact}</a>

        <button
          type="button"
          class="navlink block w-full rounded-xl px-3 py-2 text-left hover:bg-brand-50"
          id="ownerPortalBtnMobile"
          aria-haspopup="dialog"
          aria-controls="ownerGate"
        >
          {ownerPortalLabel}
        </button>
      </div>

      <div class="mt-4 flex flex-col gap-2">
        <!-- ✅ Primary -->
        <a class="btn btn-primary w-full" href={`tel:${phoneTel}`} aria-label={t.nav.callNow}>
          {t.nav.callNow}: {phoneDisplay}
        </a>

        <!-- ✅ Secondary -->
        {phoneTel2 ? (
          <a class="btn btn-outline w-full" href={`tel:${phoneTel2}`} aria-label={callAltLabel}>
            {callAltLabel}: {phoneDisplay2}
          </a>
        ) : null}

        <a class="btn btn-outline w-full" href={langHref} aria-label="Toggle language">
          {t.nav.toggle}
        </a>
      </div>
    </div>
  </div>

  <!-- ✅ Owner Gate Modal -->
  <div id="ownerGate" class="fixed inset-0 z-60 hidden" aria-hidden="true">
    <div id="ownerGateBackdrop" class="absolute inset-0 bg-black/35 backdrop-blur-sm"></div>

    <div class="fixed inset-0 grid place-items-center p-4 sm:p-6">
      <div
        role="dialog"
        aria-modal="true"
        aria-labelledby="ownerGateTitle"
        class="w-full max-w-md rounded-3xl bg-white p-5 shadow-soft ring-1 ring-slate-200/70"
        style="
          margin-top: env(safe-area-inset-top);
          margin-bottom: env(safe-area-inset-bottom);
        "
      >
        <div class="flex items-start justify-between gap-3">
          <div>
            <p id="ownerGateTitle" class="text-base font-extrabold text-brand-900">{ownerUnlockTitle}</p>
            <p class="mt-1 text-sm text-slate-600">{ownerUnlockHint}</p>
          </div>

          <button
            type="button"
            id="ownerGateClose"
            class="inline-flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 focus-visible:ring-offset-2"
            aria-label={ownerCloseLabel}
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5" aria-hidden="true">
              <path fill-rule="evenodd" d="M6.22 6.22a.75.75 0 0 1 1.06 0L12 10.94l4.72-4.72a.75.75 0 1 1 1.06 1.06L13.06 12l4.72 4.72a.75.75 0 0 1-1.06 1.06L12 13.06l-4.72 4.72a.75.75 0 0 1-1.06-1.06L10.94 12 6.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>

        <div class="mt-4">
          <label for="ownerPass" class="text-xs font-bold text-slate-700">{ownerPasswordLabel}</label>
          <input
            id="ownerPass"
            type="password"
            autocomplete="current-password"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 shadow-soft ring-1 ring-black/5 outline-none focus:border-accent-500 focus:ring-2 focus:ring-accent-500/30"
          />
          <p id="ownerErr" class="mt-2 hidden text-sm font-semibold text-red-600">{ownerErrorLabel}</p>
        </div>

        <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-center gap-2">
            <button id="ownerContinue" type="button" class="btn btn-accent w-full sm:w-auto">
              {ownerUnlockBtn}
            </button>

            <button id="ownerLogout" type="button" class="btn btn-outline w-full sm:w-auto">
              {ownerLogoutLabel}
            </button>
          </div>

          <a class="text-sm font-semibold text-accent-700 underline" href={supportHref} id="ownerForgot" rel="noopener">
            {ownerForgotLabel} <span class="no-underline">({ownerContactLabel})</span>
          </a>
        </div>

        <div class="mt-4 rounded-2xl bg-brand-50 p-3 ring-1 ring-slate-200/60">
          <p class="text-xs text-slate-600">
            {lang === "es"
              ? "Consejo: una vez que entres, el acceso queda guardado por 7 días en este dispositivo."
              : "Tip: once you enter, access is saved for 7 days on this device."}
          </p>
        </div>
      </div>
    </div>
  </div>

  <style>
    .brand-clamp {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
      max-width: 10.5rem;
    }
    @media (min-width: 640px) {
      .brand-clamp { max-width: none; }
    }

    a[data-navlink][aria-current="page"] {
      color: rgb(15 23 42);
      position: relative;
    }
    a[data-navlink][aria-current="page"]::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -10px;
      height: 2px;
      width: 100%;
      border-radius: 999px;
      background: rgba(230, 126, 34, 0.9);
    }

    #siteHeader.is-scrolled {
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
      background: rgba(255,255,255,0.88);
    }

    .rlc-reveal {
      opacity: 0;
      transform: translateY(14px);
      transition: opacity 520ms ease, transform 520ms ease;
      will-change: opacity, transform;
    }
    .rlc-reveal.is-in {
      opacity: 1;
      transform: translateY(0);
    }
    @media (prefers-reduced-motion: reduce) {
      .rlc-reveal {
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
      }
    }
  </style>

  <script
    is:inline
    define:vars={{
      OWNER_UNLOCK_UNTIL_KEY,
      OWNER_UNLOCK_DAYS,
      OWNER_HREF: ownerHref,
      OWNER_PASSWORD: ownerPassword,
      LANG: lang
    }}
  >
    function rlcBindNav() {
      if (window.__rlcNavBound) return;
      window.__rlcNavBound = true;

      const header = document.getElementById("siteHeader");

      const menuBtn = document.getElementById("menuBtn");
      const mobileMenu = document.getElementById("mobileMenu");

      const ownerGate = document.getElementById("ownerGate");
      const ownerGateBackdrop = document.getElementById("ownerGateBackdrop");
      const ownerGateClose = document.getElementById("ownerGateClose");
      const ownerPass = document.getElementById("ownerPass");
      const ownerErr = document.getElementById("ownerErr");
      const ownerContinue = document.getElementById("ownerContinue");
      const ownerLogout = document.getElementById("ownerLogout");
      const ownerPortalBtnDesktop = document.getElementById("ownerPortalBtnDesktop");
      const ownerPortalBtnMobile = document.getElementById("ownerPortalBtnMobile");

      const navLinks = Array.from(document.querySelectorAll("a[data-navlink][href^='#']"));

      function closeMobileMenu() {
        if (!menuBtn || !mobileMenu) return;
        mobileMenu.classList.add("hidden");
        menuBtn.setAttribute("aria-expanded", "false");
      }

      function toggleMobileMenu(e) {
        if (e) e.preventDefault();
        if (!menuBtn || !mobileMenu) return;
        const isOpen = !mobileMenu.classList.contains("hidden");
        if (isOpen) closeMobileMenu();
        else {
          mobileMenu.classList.remove("hidden");
          menuBtn.setAttribute("aria-expanded", "true");
        }
      }

      menuBtn?.addEventListener("click", toggleMobileMenu, { capture: true });

      function nowMs() { return Date.now(); }

      function isOwnerUnlocked() {
        try {
          const raw = localStorage.getItem(OWNER_UNLOCK_UNTIL_KEY) || "";
          const until = Number(raw);
          return Number.isFinite(until) && until > nowMs();
        } catch (_) {
          return false;
        }
      }

      function setOwnerUnlocked(days) {
        try {
          const ms = days * 24 * 60 * 60 * 1000;
          localStorage.setItem(OWNER_UNLOCK_UNTIL_KEY, String(nowMs() + ms));
        } catch (_) {}
      }

      function clearOwnerUnlocked() {
        try { localStorage.removeItem(OWNER_UNLOCK_UNTIL_KEY); } catch (_) {}
      }

      function openOwnerGate() {
        if (!ownerGate) return;

        if (isOwnerUnlocked()) {
          closeMobileMenu();
          window.location.href = OWNER_HREF;
          return;
        }

        ownerGate.classList.remove("hidden");
        ownerGate.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        ownerErr?.classList.add("hidden");
        if (ownerPass) {
          ownerPass.value = "";
          setTimeout(() => ownerPass.focus(), 60);
        }
      }

      function closeOwnerGate() {
        if (!ownerGate) return;
        ownerGate.classList.add("hidden");
        ownerGate.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        ownerErr?.classList.add("hidden");
      }

      function submitOwnerPass() {
        if (!ownerPass || !ownerErr) return;

        if (!OWNER_PASSWORD) {
          ownerErr.textContent =
            LANG === "es" ? "Acceso no disponible. Falta configuración." : "Access unavailable. Missing configuration.";
          ownerErr.classList.remove("hidden");
          return;
        }

        const entered = (ownerPass.value || "").trim();
        const ok = entered && entered === OWNER_PASSWORD;

        if (!ok) {
          ownerErr.classList.remove("hidden");
          ownerPass.focus();
          ownerPass.select?.();
          return;
        }

        setOwnerUnlocked(OWNER_UNLOCK_DAYS);
        closeOwnerGate();
        closeMobileMenu();
        window.location.href = OWNER_HREF;
      }

      function doOwnerLogout() {
        clearOwnerUnlocked();
        closeOwnerGate();
      }

      ownerPortalBtnDesktop?.addEventListener("click", (e) => {
        e.preventDefault();
        openOwnerGate();
      }, { capture: true });

      ownerPortalBtnMobile?.addEventListener("click", (e) => {
        e.preventDefault();
        closeMobileMenu();
        openOwnerGate();
      }, { capture: true });

      ownerGateClose?.addEventListener("click", (e) => {
        e.preventDefault();
        closeOwnerGate();
      }, { capture: true });

      ownerGateBackdrop?.addEventListener("click", closeOwnerGate, { capture: true });

      ownerContinue?.addEventListener("click", (e) => {
        e.preventDefault();
        submitOwnerPass();
      }, { capture: true });

      ownerLogout?.addEventListener("click", (e) => {
        e.preventDefault();
        doOwnerLogout();
      }, { capture: true });

      ownerPass?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitOwnerPass();
        if (e.key === "Escape") closeOwnerGate();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (ownerGate && !ownerGate.classList.contains("hidden")) closeOwnerGate();
          else closeMobileMenu();
        }
      });

      function smoothScrollToHash(hash) {
        try {
          const id = (hash || "").replace("#", "").trim();
          if (!id) return false;

          const el = document.getElementById(id);
          if (!el) return false;

          const headerH = header?.getBoundingClientRect?.().height || 0;
          const y = window.scrollY + el.getBoundingClientRect().top - Math.max(0, headerH + 12);

          window.history.pushState(null, "", "#" + id);
          window.scrollTo({ top: y, behavior: "smooth" });
          return true;
        } catch (_) {
          return false;
        }
      }

      navLinks.forEach((a) => {
        a.addEventListener("click", (e) => {
          const href = a.getAttribute("href") || "";
          if (!href.startsWith("#")) return;
          e.preventDefault();
          closeMobileMenu();
          smoothScrollToHash(href);
        }, { capture: true });
      });

      try {
        if (window.__rlcSpyIo && typeof window.__rlcSpyIo.disconnect === "function") {
          window.__rlcSpyIo.disconnect();
        }
      } catch (_) {}

      const sectionIds = ["services", "quote", "contact"].filter((id) => document.getElementById(id));

      const setActive = (id) => {
        navLinks.forEach((a) => {
          const href = a.getAttribute("href") || "";
          const isMatch = href === "#" + id;
          if (isMatch) a.setAttribute("aria-current", "page");
          else a.removeAttribute("aria-current");
        });
      };

      if ("IntersectionObserver" in window && sectionIds.length) {
        const headerH = header?.getBoundingClientRect?.().height || 0;

        const io = new IntersectionObserver((entries) => {
          const visible = entries
            .filter((e) => e.isIntersecting)
            .sort((a, b) => (b.intersectionRatio || 0) - (a.intersectionRatio || 0))[0];

          if (visible?.target?.id) setActive(visible.target.id);
        }, {
          root: null,
          threshold: [0.25, 0.4, 0.6],
          rootMargin: `-${Math.round(headerH + 20)}px 0px -55% 0px`
        });

        sectionIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) io.observe(el);
        });

        window.__rlcSpyIo = io;

        const initialHash = (location.hash || "").replace("#", "");
        if (initialHash && sectionIds.includes(initialHash)) setActive(initialHash);
        else setActive(sectionIds[0]);
      }

      try {
        if (window.__rlcScrollHandler) {
          window.removeEventListener("scroll", window.__rlcScrollHandler);
        }
      } catch (_) {}

      const onScroll = () => {
        const y = window.scrollY || 0;
        if (header) {
          if (y > 8) header.classList.add("is-scrolled");
          else header.classList.remove("is-scrolled");
        }
      };

      window.__rlcScrollHandler = onScroll;
      onScroll();
      window.addEventListener("scroll", onScroll, { passive: true });

      const bootHash = (location.hash || "").trim();
      if (bootHash && bootHash.startsWith("#")) {
        setTimeout(() => {
          const ok = smoothScrollToHash(bootHash);
          if (!ok) return;
        }, 50);
      }
    }

    function rlcBindScrollReveal() {
      if (window.__rlcRevealBound) return;
      window.__rlcRevealBound = true;

      const prefersReduced =
        window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      if (prefersReduced) return;

      const pickTargets = () => {
        const selectors = [
          "#services",
          "#quote",
          "#gallery",
          "footer",
          "section"
        ];

        const seen = new Set();
        const out = [];

        selectors.forEach((sel) => {
          document.querySelectorAll(sel).forEach((el) => {
            if (!el || seen.has(el)) return;
            const rect = el.getBoundingClientRect();
            const h = rect.height || el.scrollHeight || 0;
            if (h < 120) return;

            if (!el.classList.contains("rlc-reveal")) el.classList.add("rlc-reveal");
            seen.add(el);
            out.push(el);
          });
        });

        return out;
      };

      const targets = pickTargets();

      const revealNow = (el) => {
        if (!el || el.classList.contains("is-in")) return;
        el.classList.add("is-in");
      };

      if (!("IntersectionObserver" in window)) {
        targets.forEach(revealNow);
        return;
      }

      const io = new IntersectionObserver(
        (entries) => {
          for (const e of entries) {
            if (e.isIntersecting) {
              revealNow(e.target);
              io.unobserve(e.target);
            }
          }
        },
        {
          root: null,
          rootMargin: "0px 0px -12% 0px",
          threshold: 0.12,
        }
      );

      targets.forEach((el) => io.observe(el));
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        rlcBindNav();
        rlcBindScrollReveal();
      }, { once: true });
    } else {
      rlcBindNav();
      rlcBindScrollReveal();
    }

    document.addEventListener("astro:page-load", () => {
      window.__rlcNavBound = false;
      window.__rlcRevealBound = false;

      try {
        if (window.__rlcSpyIo && typeof window.__rlcSpyIo.disconnect === "function") {
          window.__rlcSpyIo.disconnect();
        }
      } catch (_) {}

      try {
        if (window.__rlcScrollHandler) {
          window.removeEventListener("scroll", window.__rlcScrollHandler);
        }
      } catch (_) {}

      rlcBindNav();
      rlcBindScrollReveal();
    });
  </script>
</header>