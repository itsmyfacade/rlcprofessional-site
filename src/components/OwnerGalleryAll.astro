---
import { fetchGalleryFeed, type GalleryItem } from "../lib/galleryFeed";

export const prerender = false;

const SCRIPT_URL = import.meta.env.PUBLIC_GOOGLE_APPS_SCRIPT_URL ?? "";

// Your sheet GIDs
const GID_EN = "0";
const GID_ES = "1337806420";

const feedEn = SCRIPT_URL ? `${SCRIPT_URL}?gid=${GID_EN}` : "";
const feedEs = SCRIPT_URL ? `${SCRIPT_URL}?gid=${GID_ES}` : "";

const [itemsEn, itemsEs] = await Promise.all([
  fetchGalleryFeed(feedEn, 500),
  fetchGalleryFeed(feedEs, 500),
]);

const mergedMap = new Map<string, GalleryItem>();
for (const it of [...itemsEn, ...itemsEs]) mergedMap.set(it.id, it);
const items = Array.from(mergedMap.values());

items.sort((a, b) => {
  const ta = a.createdAt ? Date.parse(a.createdAt) : 0;
  const tb = b.createdAt ? Date.parse(b.createdAt) : 0;
  return tb - ta;
});

function firstImage(it: GalleryItem) {
  return (it.morePhotoUrls && it.morePhotoUrls[0]) || it.afterUrl || it.beforeUrl || "";
}

function formatDate(iso?: string) {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  return d.toLocaleString();
}
---

<section class="mt-10 rounded-3xl bg-white p-6 shadow-soft ring-1 ring-slate-200/60">
  <div class="flex items-center justify-between gap-4">
    <div>
      <h2 class="text-lg font-extrabold text-slate-900">All Gallery Items</h2>
      <p class="mt-1 text-sm text-slate-600">
        This is your full gallery feed (EN + ES). Total: <strong>{items.length}</strong>
      </p>
    </div>
    <a href="#upload" class="btn btn-accent">Upload New</a>
  </div>

  {
    items.length === 0 ? (
      <div class="mt-6 rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200/60">
        <p class="text-sm text-slate-700">
          No items found yet. If you know items exist, your owner portal page was likely prerendered
          — make sure
          <strong> export const prerender = false;</strong> is at the top of the owner-upload pages.
        </p>
      </div>
    ) : (
      <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {items.map((it) => (
          <article class="rounded-2xl border border-slate-200/60 bg-white p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs font-extrabold text-slate-900">
                  {it.serviceType || "Recent Project"}
                </p>
                <p class="mt-0.5 text-[11px] text-slate-500">
                  {it.city || ""}
                  {it.createdAt ? ` • ${formatDate(it.createdAt)}` : ""}
                </p>
              </div>
              <span class="rounded-full bg-slate-100 px-2 py-1 text-[10px] font-bold text-slate-700">
                {it.videoUrl ? "VIDEO" : it.beforeUrl && it.afterUrl ? "B&A" : "PHOTO"}
              </span>
            </div>

            {it.videoUrl ? (
              <div class="mt-3 overflow-hidden rounded-xl ring-1 ring-slate-200/60 bg-white">
                <div class="aspect-video w-full bg-white relative overflow-hidden">
                  <video
                    class="absolute inset-0 h-full w-full object-contain bg-white"
                    autoplay
                    muted
                    playsinline
                    loop
                    preload="metadata"
                    controls
                    controlslist="nodownload noplaybackrate"
                  >
                    <source src={it.videoUrl} />
                  </video>
                </div>
              </div>
            ) : firstImage(it) ? (
              <div class="mt-3 overflow-hidden rounded-xl ring-1 ring-slate-200/60">
                <img
                  src={firstImage(it)}
                  alt="Gallery item"
                  class="h-48 w-full object-cover"
                  loading="lazy"
                  decoding="async"
                  referrerpolicy="no-referrer"
                />
              </div>
            ) : null}

            {it.caption ? <p class="mt-3 text-sm text-slate-700">{it.caption}</p> : null}

            {it.publicLink ? (
              <div class="mt-3">
                <a
                  class="text-sm font-semibold text-blue-700 underline"
                  href={it.publicLink}
                  target="_blank"
                  rel="noopener"
                >
                  Open shared link
                </a>
              </div>
            ) : null}

            <p class="mt-3 text-[11px] text-slate-500 break-all">ID: {it.id}</p>
          </article>
        ))}
      </div>
    )
  }
</section>
