---
import "../styles/global.css";

type Props = {
  lang: "en" | "es";
  title: string;
  description: string;
  canonical: string;
  ogImage: string; // can be absolute or a /path from site.json
};

const { lang, title, description, canonical, ogImage } = Astro.props as Props;

const isEs = lang === "es";

/**
 * ✅ Force a single public origin to eliminate mixed signals (www vs non-www, http vs https)
 * This prevents duplicate indexing + helps favicon + structured data consistency.
 */
const FORCED_ORIGIN = "https://www.rlcprofessional.com";

/**
 * ✅ Normalize canonical URL:
 * - forces https + www (FORCED_ORIGIN)
 * - standardizes /es/ slash
 * - ensures trailing slash for non-file paths
 * - removes hash
 */
function normalizeCanonical(input: string) {
  const raw = (input ?? "").trim();
  if (!raw) return `${FORCED_ORIGIN}/`;

  try {
    const u = new URL(raw);

    // Force public origin (www + https)
    const forced = new URL(FORCED_ORIGIN);
    u.protocol = forced.protocol;
    u.host = forced.host;

    // Standardize pathname slashes for root and /es/
    const p = u.pathname || "/";
    if (p === "/es") u.pathname = "/es/";
    else if (p === "") u.pathname = "/";
    else if (!p.endsWith("/") && !p.includes(".")) u.pathname = p + "/";

    // Canonical should not include hash
    u.hash = "";

    return u.toString();
  } catch (_) {
    // Fallback: treat as a path
    const path = raw.startsWith("/") ? raw : `/${raw}`;
    const u = new URL(path, FORCED_ORIGIN);

    if (u.pathname === "/es") u.pathname = "/es/";
    else if (!u.pathname.endsWith("/") && !u.pathname.includes(".")) u.pathname += "/";

    u.hash = "";
    return u.toString();
  }
}

const canonicalUrl = normalizeCanonical(canonical);

// ✅ Stable site origin (forced)
const siteOrigin = FORCED_ORIGIN;

// ✅ hreflang targets (always absolute, always stable)
const altEn = `${siteOrigin}/`;
const altEs = `${siteOrigin}/es/`;

// ✅ Make OG image absolute (Meta/Twitter prefer this)
function toAbsoluteImageUrl(input: string) {
  const s = (input ?? "").trim();
  if (!s) return s;

  // already absolute
  if (/^https?:\/\//i.test(s)) return s;

  // treat as path
  if (s.startsWith("/")) return `${siteOrigin}${s}`;
  return `${siteOrigin}/${s.replace(/^\/+/, "")}`;
}

const ogImageAbs = toAbsoluteImageUrl(ogImage);

/**
 * ✅ Title localization for known titles only (safe)
 */
function localizedTitle(input: string) {
  const s = (input ?? "").trim();
  if (!s) return s;

  if (s === "Painters in Kissimmee | RLC Professional") {
    return isEs ? "Pintores en Kissimmee | RLC Professional" : s;
  }

  if (s === "Painters in Haines City | RLC Professional") {
    return isEs ? "Pintores en Haines City | RLC Professional" : s;
  }

  return s;
}

const pageTitle = localizedTitle(title);
const ogTitle = pageTitle;

// Route-aware perf hints (only preload hero assets on home pages)
const pathname = Astro.url?.pathname ?? "/";
const isHome = pathname === "/" || pathname === "/es/" || pathname === "/es";

/**
 * ✅ Structured data safety:
 * If any JSON-LD gets built with undefined / invalid values,
 * Search Console can flag it as "unparsable".
 * This helper guarantees valid JSON output.
 */

// ✅ Cache-bust favicons when you update them (helps browsers + sometimes Google)
const FAVICON_VERSION = "3"; // bump this when favicon assets change
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="google-site-verification" content="u1JWrF-PWC0wnFhng-0jcpJB54mOAiE0LU-ZNC5syJE" />

    <title>{pageTitle}</title>
    <meta name="description" content={description} />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href={canonicalUrl} />

    <!-- ✅ Bilingual SEO (absolute, stable) -->
    <link rel="alternate" hreflang="en" href={altEn} />
    <link rel="alternate" hreflang="es" href={altEs} />
    <link rel="alternate" hreflang="x-default" href={altEn} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageAbs} />
    <meta property="og:locale" content={isEs ? "es_ES" : "en_US"} />
    <meta property="og:locale:alternate" content={isEs ? "en_US" : "es_ES"} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ogTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageAbs} />

    <!-- Browser theming -->
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#1A2B3C" />

    <!-- ✅ Favicons (cache-busted) -->
    <link rel="icon" href={`/favicon.ico?v=${FAVICON_VERSION}`} sizes="any" />
    <link rel="shortcut icon" href={`/favicon.ico?v=${FAVICON_VERSION}`} />
    <link rel="icon" type="image/svg+xml" href={`/favicon.svg?v=${FAVICON_VERSION}`} />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href={`/favicon-96x96.png?v=${FAVICON_VERSION}`}
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href={`/apple-touch-icon.png?v=${FAVICON_VERSION}`}
    />
    <link rel="manifest" href={`/site.webmanifest?v=${FAVICON_VERSION}`} />

    <!-- Perf hints (safe) -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />

    {
      isHome ? (
        <>
          <link rel="preload" as="image" href="/assets/hero-tools.jpg" />
          <link rel="preload" as="image" href="/assets/hero.jpg" />
        </>
      ) : null
    }

    <!-- ✅ Optional, safe security policy for embeds (doesn't break your site) -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />

    <style>
      html {
        scroll-behavior: smooth;
      }

      body {
        min-height: 100vh;
      }

      html:not(.js) .rlc-paint-overlay {
        display: none;
      }

      .rlc-paint-overlay {
        position: fixed;
        inset: 0;
        z-index: 9998;
        pointer-events: none;
        background:
          radial-gradient(1200px circle at 20% 10%, rgba(230, 126, 34, 0.1), transparent 55%),
          linear-gradient(135deg, rgba(26, 43, 60, 0.92), rgba(26, 43, 60, 0.82));
        opacity: 1;
        transform: translateZ(0);
      }

      .rlc-paint-stroke {
        position: absolute;
        inset: -20%;
        background:
          radial-gradient(
            900px 260px at 18% 35%,
            rgba(255, 255, 255, 0.2),
            rgba(255, 255, 255, 0) 70%
          ),
          radial-gradient(
            900px 300px at 34% 55%,
            rgba(230, 126, 34, 0.25),
            rgba(230, 126, 34, 0) 72%
          ),
          radial-gradient(
            900px 260px at 58% 45%,
            rgba(255, 255, 255, 0.16),
            rgba(255, 255, 255, 0) 70%
          ),
          radial-gradient(
            900px 260px at 78% 62%,
            rgba(230, 126, 34, 0.18),
            rgba(230, 126, 34, 0) 72%
          );
        filter: blur(10px);
        opacity: 0.95;
        transform: translateX(-22%) rotate(-6deg);
      }

      html.js body {
        opacity: 1;
      }

      html.js.rlc-ready .rlc-paint-overlay {
        opacity: 0;
        transition: opacity 520ms ease;
      }
      html.js.rlc-ready .rlc-paint-stroke {
        transform: translateX(18%) rotate(-6deg);
        transition: transform 720ms cubic-bezier(0.22, 1, 0.36, 1);
      }

      [data-reveal] {
        opacity: 1;
        transform: none;
      }
      html.js [data-reveal] {
        opacity: 0;
        transform: translateY(10px);
        transition:
          opacity 520ms ease,
          transform 620ms cubic-bezier(0.22, 1, 0.36, 1);
        will-change: opacity, transform;
      }
      html.js [data-reveal].is-visible {
        opacity: 1;
        transform: translateY(0);
      }

      @media (prefers-reduced-motion: reduce) {
        html {
          scroll-behavior: auto;
        }
        .rlc-paint-overlay,
        .rlc-paint-stroke {
          display: none !important;
        }
        html.js [data-reveal] {
          opacity: 1 !important;
          transform: none !important;
          transition: none !important;
        }
      }
    </style>

    <script is:inline>
      {
        `
        document.documentElement.classList.add("js");
      `;
      }
    </script>
  </head>

  <body>
    <noscript>
      <div
        style="padding:12px 16px; background:#fff3cd; color:#1a1a1a; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;"
      >
        This site works best with JavaScript enabled.
      </div>
    </noscript>

    <div class="rlc-paint-overlay" aria-hidden="true">
      <div class="rlc-paint-stroke" aria-hidden="true"></div>
    </div>

    <slot />

    <script is:inline>
      {
        `
        (function () {
          const root = document.documentElement;

          requestAnimationFrame(() => {
            root.classList.add("rlc-ready");
          });

          const prefersReduced =
            window.matchMedia &&
            window.matchMedia("(prefers-reduced-motion: reduce)").matches;

          if (prefersReduced) return;

          const els = Array.from(document.querySelectorAll("[data-reveal]"));
          if (!els.length) return;

          const io = new IntersectionObserver(
            (entries) => {
              for (const entry of entries) {
                if (entry.isIntersecting) {
                  entry.target.classList.add("is-visible");
                  io.unobserve(entry.target);
                }
              }
            },
            { root: null, threshold: 0.12, rootMargin: "0px 0px -10% 0px" }
          );

          els.forEach((el) => io.observe(el));
        })();
      `;
      }
    </script>
  </body>
</html>
