---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Nav from "../../components/Nav.astro";
import site from "../../content/site.json";
import es from "../../i18n/es.json";

// ✅ Same key used by Nav.astro
const OWNER_UNLOCK_UNTIL_KEY = "rlc_owner_unlocked_until";
const homeHref = "/es/";

// Canonical must be a string
const canonical = Astro.url.href;
---

<BaseLayout
  lang="es"
  title="Subida del Dueño | RLC Professional"
  description="Portal seguro para subir contenido."
  canonical={canonical}
  ogImage="/assets/og.jpg"
>
  <Nav t={es} site={site} lang="es" />

  <main class="mx-auto max-w-3xl px-4 py-12">
    <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
      <div>
        <h1 class="text-2xl font-extrabold text-brand-900">Subida del Dueño</h1>
        <p class="mt-2 text-slate-700">
          Esta página es para que el dueño del negocio suba fotos/videos nuevos a la galería del
          sitio.
        </p>
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="btn btn-outline" href={site.tallyBeforeAfterUrlEs} target="_blank" rel="noopener">
          Abrir formulario en otra pestaña
        </a>

        <button
          type="button"
          class="btn btn-accent"
          id="rlc-lock-owner"
          aria-label="Bloquear portal del dueño en este dispositivo"
        >
          Bloquear Portal
        </button>
      </div>
    </header>

    <div class="mt-6 card">
      <p class="text-sm text-slate-700">
        Abra el formulario abajo. (Todavía necesitará la contraseña de Tally.)
      </p>

      <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-slate-200/60 bg-white">
        <iframe
          title="Formulario de Subida RLC"
          src={site.tallyBeforeAfterUrlEs}
          loading="lazy"
          class="w-full"
          style="height: 78vh;"
          referrerpolicy="no-referrer"></iframe>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Nota de seguridad: este portal se desbloquea por dispositivo por un tiempo limitado. Use
        “Bloquear Portal” al terminar.
      </p>
    </div>
  </main>

  <!-- ✅ Prevent indexing/caching of owner portal -->
  <head>
    <meta name="robots" content="noindex,nofollow,noarchive" />
  </head>

  <noscript>
    <div class="mx-auto max-w-3xl px-4 py-6">
      <div class="rounded-2xl bg-white p-4 ring-1 ring-slate-200/60 shadow-soft">
        <p class="text-sm text-slate-700">
          Se requiere JavaScript para acceder al portal de subida del dueño.
        </p>
        <a class="btn btn-accent mt-3 w-fit" href={homeHref}>Volver al inicio</a>
      </div>
    </div>
  </noscript>

  <!-- ✅ Hard gate: requires Owner Portal unlock (7-day device access) -->
  <script is:inline>
    {
      `
      (function () {
        const KEY = ${JSON.stringify(OWNER_UNLOCK_UNTIL_KEY)};
        const HOME = ${JSON.stringify(homeHref)};

        const now = Date.now();
        let until = 0;

        try {
          until = Number(localStorage.getItem(KEY) || "0");
        } catch (_) {
          until = 0;
        }

        const ok = Number.isFinite(until) && until > now;

        if (!ok) {
          // Redirect immediately to /es/ if not unlocked
          window.location.replace(HOME);
          return;
        }

        // Lock button: remove unlock for this device
        const btn = document.getElementById("rlc-lock-owner");
        if (btn) {
          btn.addEventListener("click", () => {
            try { localStorage.removeItem(KEY); } catch (_) {}
            window.location.replace(HOME);
          }, { passive: true });
        }
      })();
    `;
    }
  </script>
</BaseLayout>
