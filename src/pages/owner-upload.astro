---
import BaseLayout from "../layouts/BaseLayout.astro";
import Nav from "../components/Nav.astro";
import site from "../content/site.json";
import en from "../i18n/en.json";

// ✅ Same key used by Nav.astro
const OWNER_UNLOCK_UNTIL_KEY = "rlc_owner_unlocked_until";
const homeHref = "/";

// Canonical must be a string (Astro.url.href is fine)
const canonical = Astro.url.href;
---

<BaseLayout
  lang="en"
  title="Owner Upload | RLC Professional"
  description="Secure owner upload portal."
  canonical={canonical}
  ogImage="/assets/og.jpg"
>
  <Nav t={en} site={site} lang="en" />

  <main class="mx-auto max-w-3xl px-4 py-12">
    <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
      <div>
        <h1 class="text-2xl font-extrabold text-brand-900">Owner Upload</h1>
        <p class="mt-2 text-slate-700">
          This page is for the business owner to upload new photos/videos to the website gallery.
        </p>
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="btn btn-outline" href={site.tallyBeforeAfterUrlEn} target="_blank" rel="noopener">
          Open form in new tab
        </a>

        <button
          type="button"
          class="btn btn-accent"
          id="rlc-lock-owner"
          aria-label="Lock Owner Portal on this device"
        >
          Lock Owner Portal
        </button>
      </div>
    </header>

    <div class="mt-6 card">
      <p class="text-sm text-slate-700">
        Open the upload form below. (You will still need the Tally password.)
      </p>

      <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-slate-200/60 bg-white">
        <iframe
          title="RLC Upload Form"
          src={site.tallyBeforeAfterUrlEn}
          loading="lazy"
          class="w-full"
          style="height: 78vh;"
          referrerpolicy="no-referrer"></iframe>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Security note: This portal is unlocked per device for a limited time. Use “Lock Owner
        Portal” when finished.
      </p>
    </div>
  </main>

  <!-- ✅ Prevent indexing/caching of owner portal -->
  <head>
    <meta name="robots" content="noindex,nofollow,noarchive" />
  </head>

  <noscript>
    <div class="mx-auto max-w-3xl px-4 py-6">
      <div class="rounded-2xl bg-white p-4 ring-1 ring-slate-200/60 shadow-soft">
        <p class="text-sm text-slate-700">
          JavaScript is required to access the Owner Upload portal.
        </p>
        <a class="btn btn-accent mt-3 w-fit" href={homeHref}>Go back home</a>
      </div>
    </div>
  </noscript>

  <!-- ✅ Hard gate: requires Owner Portal unlock (7-day device access) -->
  <script is:inline>
    {
      `
      (function () {
        const KEY = ${JSON.stringify(OWNER_UNLOCK_UNTIL_KEY)};
        const HOME = ${JSON.stringify(homeHref)};

        const now = Date.now();
        let until = 0;

        try {
          until = Number(localStorage.getItem(KEY) || "0");
        } catch (_) {
          until = 0;
        }

        const ok = Number.isFinite(until) && until > now;

        if (!ok) {
          // Redirect immediately to home if not unlocked
          window.location.replace(HOME);
          return;
        }

        // Lock button: remove unlock for this device
        const btn = document.getElementById("rlc-lock-owner");
        if (btn) {
          btn.addEventListener("click", () => {
            try { localStorage.removeItem(KEY); } catch (_) {}
            window.location.replace(HOME);
          }, { passive: true });
        }
      })();
    `;
    }
  </script>
</BaseLayout>
