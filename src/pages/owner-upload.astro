---
import BaseLayout from "../layouts/BaseLayout.astro";
import Nav from "../components/Nav.astro";
import site from "../content/site.json";
import en from "../i18n/en.json";

// ✅ Same key used by Nav.astro
const OWNER_UNLOCK_UNTIL_KEY = "rlc_owner_unlocked_until";
const homeHref = "/";

// Canonical must be a string (Astro.url.href is fine)
const canonical = Astro.url.href;
---

<BaseLayout
  lang="en"
  title="Owner Upload | RLC Professional"
  description="Secure owner upload portal."
  canonical={canonical}
  ogImage="/assets/og.jpg"
>
  <Nav t={en} site={site} lang="en" />

  <main class="mx-auto max-w-3xl px-4 py-12">
    <h1 class="text-2xl font-extrabold text-brand-900">Owner Upload</h1>
    <p class="mt-2 text-slate-700">
      This page is for the business owner to upload new photos/videos to the website gallery.
    </p>

    <div class="mt-6 card">
      <p class="text-sm text-slate-700">
        Open the upload form below. (You will still need the Tally password.)
      </p>

      <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-slate-200/60 bg-white">
        <iframe
          title="RLC Upload Form"
          src={site.tallyBeforeAfterUrlEn}
          loading="lazy"
          class="w-full"
          style="height: 78vh;"
          referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </main>

  <!-- ✅ Hard gate: requires Owner Portal unlock (7-day device access) -->
  <script is:inline>
    {
      `
      (function () {
        const KEY = ${JSON.stringify(OWNER_UNLOCK_UNTIL_KEY)};
        const HOME = ${JSON.stringify(homeHref)};

        const now = Date.now();
        let until = 0;

        try {
          until = Number(localStorage.getItem(KEY) || "0");
        } catch (_) {
          until = 0;
        }

        const ok = Number.isFinite(until) && until > now;

        if (!ok) {
          // Redirect immediately to home if not unlocked
          window.location.replace(HOME);
        }
      })();
    `;
    }
  </script>
</BaseLayout>
