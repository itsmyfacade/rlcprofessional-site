---
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import Nav from "../components/Nav.astro";
import site from "../content/site.json";
import en from "../i18n/en.json";

const OWNER_UNLOCK_UNTIL_KEY = "rlc_owner_unlocked_until";
const homeHref = "/";

const canonical = Astro.url.href;

// Keep these constants as-is
const GID_EN = "0";
const GID_ES = "1337806420";

// ✅ IMPORTANT: do NOT fetch Google/AppScript feed directly from browser.
// Always fetch via your server proxy endpoint so CORS/auth never breaks.
const feedEn = `/api/gallery-feed?gid=${GID_EN}`;
const feedEs = `/api/gallery-feed?gid=${GID_ES}`;
---

<BaseLayout
  lang="en"
  title="Owner Upload | RLC Professional"
  description="Secure owner upload portal."
  canonical={canonical}
  ogImage="/assets/og.jpg"
>
  <Nav t={en} site={site} lang="en" />

  <main class="mx-auto max-w-3xl px-4 py-12">
    <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
      <div>
        <h1 class="text-2xl font-extrabold text-brand-900">Owner Upload</h1>
        <p class="mt-2 text-slate-700">
          Upload new photos/videos and manage what’s currently live on the website — without leaving
          this page.
        </p>
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="btn btn-outline" href={site.tallyBeforeAfterUrlEn} target="_blank" rel="noopener">
          Open form in new tab
        </a>

        <button
          type="button"
          class="btn btn-accent"
          id="rlc-lock-owner"
          aria-label="Lock Owner Portal on this device"
        >
          Lock Owner Portal
        </button>
      </div>
    </header>

    <div class="mt-6 card">
      <p class="text-sm text-slate-700">
        Use the upload form below. (You will still need the Tally password.)
      </p>

      <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-slate-200/60 bg-white">
        <iframe
          title="RLC Upload Form"
          src={site.tallyBeforeAfterUrlEn}
          loading="lazy"
          class="w-full"
          style="height: 78vh;"
          referrerpolicy="no-referrer"></iframe>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Security note: This portal is unlocked per device for a limited time. Use “Lock Owner
        Portal” when finished.
      </p>
    </div>
    {
      /* 
    <!-- ✅ LIVE GALLERY (EN + ES) + ONE-CLICK DELETE -->
    <section class="mt-6 card">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h2 class="text-lg font-bold text-brand-900">Live Gallery (All Items)</h2>
          <p class="mt-1 text-sm text-slate-700">
            This list automatically includes <span class="font-semibold">English + Spanish</span> uploads.
            Click <span class="font-semibold">✕</span> to remove an item (it moves to{" "}
            <span class="font-semibold">TRASHCAN</span>).
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button type="button" class="btn btn-outline" id="rlc-gallery-refresh">Refresh</button>
        </div>
      </div>

      <div class="mt-4">
        <div
          class="hidden rounded-2xl bg-slate-50 p-3 text-sm text-slate-800 ring-1 ring-slate-200/60"
          id="rlc-gallery-status"
          role="status"
          aria-live="polite"
        >
        </div>
      </div>

      <div class="mt-4 grid gap-3 sm:grid-cols-2" id="rlc-gallery-list"></div>

      <p class="mt-3 text-xs text-slate-500">
        Note: Delete = safe delete. The row is moved into TRASHCAN in Google Sheets.
      </p>
    </section>
    */
    }
  </main>

  <head>
    <meta name="robots" content="noindex,nofollow,noarchive" />
  </head>

  <noscript>
    <div class="mx-auto max-w-3xl px-4 py-6">
      <div class="rounded-2xl bg-white p-4 ring-1 ring-slate-200/60 shadow-soft">
        <p class="text-sm text-slate-700">
          JavaScript is required to access the Owner Upload portal.
        </p>
        <a class="btn btn-accent mt-3 w-fit" href={homeHref}>Go back home</a>
      </div>
    </div>
  </noscript>

  <script is:inline>
    {
      `
      (function () {
        // ✅ Always use explicit runtime constants (NEVER reference "homeHref" inside JS)
        const KEY = ${JSON.stringify(OWNER_UNLOCK_UNTIL_KEY)};
        const HOME = "/";

        // ✅ now points to server proxy (no CORS/auth problems)
        const FEED_EN = ${JSON.stringify(feedEn)};
        const FEED_ES = ${JSON.stringify(feedEs)};

        const GID_EN = ${JSON.stringify(GID_EN)};
        const GID_ES = ${JSON.stringify(GID_ES)};

        const TRASH_API = "/api/gallery-trash";

        // ✅ Gate (must be unlocked, else redirect)
        const now = Date.now();
        let until = 0;
        try { until = Number(localStorage.getItem(KEY) || "0"); } catch (_) { until = 0; }
        const ok = Number.isFinite(until) && until > now;
        if (!ok) { window.location.replace(HOME); return; }

        const lockBtn = document.getElementById("rlc-lock-owner");
        if (lockBtn) {
          lockBtn.addEventListener("click", () => {
            try { localStorage.removeItem(KEY); } catch (_) {}
            window.location.replace(HOME);
          }, { passive: true });
        }

        const status = document.getElementById("rlc-gallery-status");
        const list = document.getElementById("rlc-gallery-list");
        const refreshBtn = document.getElementById("rlc-gallery-refresh");

        function setStatus(msg, kind) {
          if (!status) return;
          status.classList.remove("hidden");
          status.textContent = msg;

          status.style.background = kind === "ok" ? "#ecfdf5" : kind === "warn" ? "#fffbeb" : "#fef2f2";
          status.style.color = kind === "ok" ? "#065f46" : kind === "warn" ? "#92400e" : "#991b1b";
          status.style.borderColor = kind === "ok" ? "rgba(16,185,129,0.25)" : kind === "warn" ? "rgba(245,158,11,0.35)" : "rgba(239,68,68,0.30)";
          status.style.borderWidth = "1px";
          status.style.borderStyle = "solid";
        }

        function clearList() { if (list) list.innerHTML = ""; }

        function esc(s) {
          return String(s ?? "").replace(/[&<>"']/g, (c) => (
            c === "&" ? "&amp;" :
            c === "<" ? "&lt;" :
            c === ">" ? "&gt;" :
            c === '"' ? "&quot;" : "&#39;"
          ));
        }

        function firstUrlFromCell(v) {
          const s = String(v || "").trim();
          if (!s) return "";
          const parts = s.split(/\\s+/g).map(p => p.trim()).filter(Boolean);
          for (const p of parts) {
            if (/^https?:\\/\\//i.test(p)) return p;
          }
          return "";
        }

        function isLikelyImageUrl(url) {
          const u = String(url || "").toLowerCase();
          return /^https?:\\/\\//.test(u) && (
            u.includes(".jpg") || u.includes(".jpeg") || u.includes(".png") || u.includes(".webp") || u.includes(".gif") ||
            u.includes("storage.tally.so")
          );
        }

        function parseCsv(text) {
          const rows = [];
          let cur = "";
          let row = [];
          let inQuotes = false;

          for (let i = 0; i < text.length; i++) {
            const ch = text[i];

            if (ch === '"') {
              const next = text[i + 1];
              if (inQuotes && next === '"') { cur += '"'; i++; }
              else { inQuotes = !inQuotes; }
              continue;
            }

            if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }

            if ((ch === "\\n" || ch === "\\r") && !inQuotes) {
              if (ch === "\\r" && text[i + 1] === "\\n") i++;
              row.push(cur); cur = "";
              if (row.some((c) => String(c || "").trim().length)) rows.push(row);
              row = [];
              continue;
            }

            cur += ch;
          }

          row.push(cur);
          if (row.some((c) => String(c || "").trim().length)) rows.push(row);
          if (rows.length < 2) return [];

          const headers = rows[0].map((h, idx) => {
            const cleaned = String(h ?? "").trim().replace(/^"|"$/g, "");
            return cleaned.length ? cleaned : "__col" + idx;
          });

          const out = [];
          for (let r = 1; r < rows.length; r++) {
            const cells = rows[r];
            const obj = {};
            headers.forEach((h, idx) => {
              const raw = cells[idx] ?? "";
              obj[h] = typeof raw === "string" ? raw.replace(/^"|"$/g, "") : raw;
            });
            out.push(obj);
          }
          return out;
        }

        async function fetchFeed(url) {
          if (!url) throw new Error("Missing gallery feed URL.");

          const res = await fetch(url, { method: "GET", cache: "no-store" });
          const text = await res.text();
          const contentType = (res.headers.get("content-type") || "").toLowerCase();

          if (!res.ok) {
            throw new Error("Feed HTTP " + res.status + " (" + res.statusText + ")");
          }

          if (contentType.includes("application/json") || text.trim().startsWith("{") || text.trim().startsWith("[")) {
            let data = null;
            try { data = JSON.parse(text); } catch (_) { data = null; }

            if (Array.isArray(data)) return data;
            if (data && data.ok === true && Array.isArray(data.rows)) return data.rows;
            if (data && Array.isArray(data.submissions)) return data.submissions;
            if (data && Array.isArray(data.data)) return data.data;
            if (data && Array.isArray(data.items)) return data.items;

            return [];
          }

          const rows = parseCsv(text);
          return Array.isArray(rows) ? rows : [];
        }

        function pickId(row) {
          if (!row || typeof row !== "object") return "";
          if (row.id) return String(row.id);
          if (row.ID) return String(row.ID);
          if (row.Id) return String(row.Id);
          if (row.__col0) return String(row.__col0);
          return "";
        }

        function pickTitle(row, lang) {
          if (!row || typeof row !== "object") return "Gallery item";
          if (lang === "es") {
            const candidates = ["Nombre del Cliente / Proyecto (opcional)", "Tipo de Servicio", "Ciudad", "Descripcion / Notas (opcional)"];
            for (const k of candidates) if (row[k]) return String(row[k]);
            return "Elemento";
          }
          const candidates = ["Customer / Project Name (optional)", "Service Type", "City", "Caption"];
          for (const k of candidates) if (row[k]) return String(row[k]);
          return "Gallery item";
        }

        function pickMediaUrl(row, lang) {
          if (!row || typeof row !== "object") return "";

          const preferred = [
            "Single Photo / Multiple Photos__link",
            "Before Photo__link",
            "After Photo__link",
            "Video__link",
            "Public Media Link (Google Photos / Drive)__link",
            "Enlace Publico (Google Fotos / Drive)__link",
            "Foto de Antes__link",
            "Foto de Despues__link",
          ];

          for (const k of preferred) {
            if (row[k]) return firstUrlFromCell(row[k]);
          }

          const preferredPlain = lang === "es"
            ? ["Una Foto / Varias Fotos", "Foto de Antes", "Foto de Despues", "Enlace Publico (Google Fotos / Drive)", "Video"]
            : ["Single Photo / Multiple Photos", "Before Photo", "After Photo", "Public Media Link (Google Photos / Drive)", "Video"];

          for (const k of preferredPlain) {
            if (row[k]) {
              const url = firstUrlFromCell(row[k]);
              if (url) return url;
            }
          }

          for (const k of Object.keys(row)) {
            const v = row[k];
            if (typeof v === "string") {
              const url = firstUrlFromCell(v);
              if (url) return url;
            }
          }

          return "";
        }

        async function trashById({ gid, id }) {
          const res = await fetch(TRASH_API, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
              id: String(id || "").trim(),
              gid: String(gid || "").trim(),
              reason: "owner portal delete"
            })
          });

          const data = await res.json().catch(() => null);

          if (!res.ok || !data || data.ok !== true) {
            const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "Delete failed.";
            throw new Error(msg);
          }
          return data;
        }

        function render(items) {
          clearList();
          if (!list) return;

          const sliced = items.slice().reverse().slice(0, 120);

          if (!sliced.length) {
            list.innerHTML = '<div class="sm:col-span-2 text-sm text-slate-600">No items found.</div>';
            return;
          }

          for (const it of sliced) {
            const row = it.row;
            const lang = it.lang;
            const gid = it.gid;

            const id = pickId(row);
            const title = pickTitle(row, lang);
            const media = pickMediaUrl(row, lang);

            const card = document.createElement("div");
            card.className = "relative overflow-hidden rounded-2xl ring-1 ring-slate-200/60 bg-white";

            const badge = document.createElement("div");
            badge.className = "absolute left-2 top-2 rounded-lg px-2 py-1 text-[11px] font-semibold ring-1 ring-slate-200/70 bg-white/90 text-slate-800";
            badge.textContent = lang === "es" ? "ES" : "EN";

            const x = document.createElement("button");
            x.type = "button";
            x.className = "absolute right-2 top-2 grid h-9 w-9 place-items-center rounded-xl bg-white/90 text-slate-900 ring-1 ring-slate-200/70 shadow-sm hover:bg-white";
            x.setAttribute("aria-label", "Delete item");
            x.textContent = "✕";

            const body = document.createElement("div");
            body.className = "p-4 pt-12";

            const meta = document.createElement("div");
            meta.className = "min-w-0";
            meta.innerHTML =
              '<div class="text-sm font-semibold text-slate-900 truncate">' + esc(title) + '</div>' +
              (id
                ? '<div class="mt-1 text-xs text-slate-500">ID: <span class="font-mono">' + esc(id) + '</span></div>'
                : '<div class="mt-1 text-xs text-rose-700">Missing ID in row</div>'
              );

            const preview = document.createElement("div");
            preview.className = "mt-3 overflow-hidden rounded-xl ring-1 ring-slate-200/60 bg-slate-50";

            if (media && isLikelyImageUrl(media)) {
              preview.innerHTML =
                '<a href="' + esc(media) + '" target="_blank" rel="noopener" class="block">' +
                '<img src="' + esc(media) + '" alt="" loading="lazy" class="h-44 w-full object-cover" />' +
                '</a>';
            } else if (media) {
              preview.innerHTML =
                '<a href="' + esc(media) + '" target="_blank" rel="noopener" class="block p-3 text-sm text-brand-900 underline underline-offset-2">' +
                'Open media link' +
                '</a>';
            } else {
              preview.innerHTML = '<div class="p-3 text-sm text-slate-600">No media link found.</div>';
            }

            const hint = document.createElement("div");
            hint.className = "mt-3 text-xs text-slate-500";
            hint.textContent = "Click ✕ to move this row to TRASHCAN.";

            body.appendChild(meta);
            body.appendChild(preview);
            body.appendChild(hint);

            card.appendChild(badge);
            card.appendChild(x);
            card.appendChild(body);

            x.addEventListener("click", async () => {
              if (!id) { setStatus("This row has no id field, so it cannot be deleted by ID.", "err"); return; }

              const confirmed = window.confirm(
                "Move this item to TRASHCAN?\\n\\nLanguage: " + (lang === "es" ? "Spanish (ES)" : "English (EN)") +
                "\\nID: " + id +
                "\\n\\nThis removes it from the live gallery."
              );
              if (!confirmed) return;

              x.disabled = true;
              x.textContent = "…";

              try {
                await trashById({ gid, id });
                setStatus("✅ Deleted. Moved to TRASHCAN.", "ok");
                card.remove();
              } catch (err) {
                setStatus("❌ " + (err && err.message ? err.message : "Delete failed."), "err");
              } finally {
                x.disabled = false;
                x.textContent = "✕";
              }
            });

            list.appendChild(card);
          }
        }

        async function refresh() {
          try {
            setStatus("Loading live items (EN + ES)…", "warn");

            const [rowsEn, rowsEs] = await Promise.all([
              fetchFeed(FEED_EN),
              fetchFeed(FEED_ES)
            ]);

            const items = [
              ...rowsEn.map((row) => ({ row, lang: "en", gid: GID_EN })),
              ...rowsEs.map((row) => ({ row, lang: "es", gid: GID_ES })),
            ];

            render(items);
            setStatus("✅ Loaded: " + rowsEn.length + " EN + " + rowsEs.length + " ES", "ok");
          } catch (err) {
            setStatus("❌ " + (err && err.message ? err.message : "Failed to load feed."), "err");
            clearList();
          }
        }

        if (refreshBtn) refreshBtn.addEventListener("click", refresh);
        refresh();
      })();
      `;
    }
  </script>
</BaseLayout>
